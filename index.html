<!doctype html>
<html>
  <head>
    <title>Socket.IO planning poker</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <meta name="viewport" content="width=device-width">
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }

      body {
        padding: 0;
        font-family: 'Roboto', sans-serif;
        color: #333;
        background: white;
        font-size: 16px;
      }

      form {
        text-align: center;
      }

      #topic-wrapper {
        border-bottom: 2px solid #dfe6e8;
        padding: 10px;
        box-shadow: 0 0 5px #BBB;
        background: #f3f6f7;
      }
      #topic {
        border-radius: 3px;
        border: 2px solid #dfe6e8;
        padding: 0.5em;
        width: 100%;
        font-size: 1.5em;
        text-align: center;
        background: white;
        color: gray;
        padding: 10px;
      }

      #topic::-webkit-input-placeholder {
        color: gray;
      }

      #reset-wrapper {
        text-align: center;
      }
      #reset {
        padding: 10px;
        margin-bottom: 1em;
        display: inline-block;

        font-size: 1em;
      }

      #messages {
        list-style-type: none;
        margin: 0; padding: 0;
        overflow-y: scroll;
        height: 200px;
        color: white;
        background: #333;
        font-size: 0.8em;
      }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) {

      }
      #messages { margin-bottom: 40px }

      .cards {
        margin-top: 20px;
        text-align: center;
        padding: 20px;
        background: white;
        padding: 30px 10px;
      }

      .card {
        display: inline-block;
        width: 70px;
        height: 80px;
        line-height: 70px;
        padding: 10px;
        margin-right: 5px;
        margin-bottom: 5px;
        text-align: center;
        font-size: 3em;
        cursor: pointer;
        position: relative;
        background: white;
        border-radius: 3px;
      }

      .card input {
      	position: absolute;
      	z-index: -1;
      	opacity: 0;
      }

      .card__indicator {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: 2px solid #dfe6e8;
        border-radius: 3px;
      }

      /* Hover and focus states */
      .card:hover input ~ .card__indicator,
      .card input:focus ~ .card__indicator {
      	border-color: #444;
      }

      /* Checked state */
      .card input:checked ~ .card__indicator {
      	border-color: #09D;
        background: #09D;
        color: white;
      }

      /* Hover state whilst checked */
      .card:hover input:not([disabled]):checked ~ .card__indicator,
      .card input:checked:focus ~ .card__indicator {
      	border-color: #09D;
      }

      /* Disabled state */
      .card input:disabled ~ .card__indicator {
      	pointer-events: none;
      	opacity: .6;
      	background: #e6e6e6;
      }

      .card .votes {
        position: absolute;
        top: -10px;
        right: -10px;
        background: #333;
        color: white;
        width: 20px;
        height: 20px;
        font-size: 12px;
        line-height: 20px;
        font-weight: bold;
        border-radius: 50%;
        z-index: 1;
      }

      #votes {
        margin: 1em 0;
        min-height: 70px;
        text-align: center;
      }

      #votes li {
        display: inline-block;
        background: #ccc;
        padding: 5px;
        margin-right: 5px;
        margin-bottom: 5px;
      }

      #votes li span {
        display: inline-block;
        height: 30px;
        line-height: 30px;
      }

      #votes li .vote {
        display: inline-block;
        background: #999;
        color: white;
        width: 30px;
        text-align: center;
        margin-left: 10px;
      }

    /*

      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }*/

    </style>
  </head>
  <body>
    <form action="">
      <div id="topic-wrapper">
        <textarea id="topic" placeholder="Task/UserStory"></textarea>
      </div>

      <div class="cards">
        <label class="card card--radio">
      		<input type="radio" name="points" value="0" class="reset">
          <div class="card__indicator">X</div>
          <div class="votes"></div>
      	</label>
        <label class="card card--radio">
      		<input type="radio" name="points" value="1" >
          <div class="card__indicator">1</div>
          <div class="votes"></div>
      	</label>
        <label class="card card--radio">
      		<input type="radio" name="points" value="2" >
          <div class="card__indicator">2</div>
          <div class="votes"></div>
      	</label>
        <label class="card card--radio">
      		<input type="radio" name="points" value="3" >
          <div class="card__indicator">3</div>
          <div class="votes"></div>
      	</label>
        <label class="card card--radio">
      		<input type="radio" name="points" value="5" >
          <div class="card__indicator">5</div>
          <div class="votes"></div>
      	</label>
        <label class="card card--radio">
      		<input type="radio" name="points" value="8" >
          <div class="card__indicator">8</div>
          <div class="votes"></div>
      	</label>
        <label class="card card--radio">
      		<input type="radio" name="points" value="13" >
          <div class="card__indicator">13</div>
          <div class="votes"></div>
      	</label>
        <label class="card card--radio">
      		<input type="radio" name="points" value="21" >
          <div class="card__indicator">21</div>
          <div class="votes"></div>
      	</label>
        <label class="card card--radio">
      		<input type="radio" name="points" value="34" >
          <div class="card__indicator">34</div>
          <div class="votes"></div>
      	</label>
        <label class="card card--radio">
      		<input type="radio" name="points" value="55" >
          <div class="card__indicator">55</div>
          <div class="votes"></div>
      	</label>
        <label class="card card--radio">
      		<input type="radio" name="points" value="89" >
          <div class="card__indicator">89</div>
          <div class="votes"></div>
      	</label>
      </div>
    </form>

    <ul id="votes">
      <li><span class="name">Anonymous</span><span class="vote">0</li>
    </ul>

    <div id="reset-wrapper">
      <button id="reset" type="button">Reset All!</button>
    </div>

    <ul id="messages"></ul>

    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      $(function () {

        // Socket:
        var socket = io();
        var data = {
          votes : {}
        };

        socket.on('connect', function() {
          socket.emit('set nickname', prompt('What is your nickname?'));
        });

        socket.on('message', function(msg){
          $('#messages').prepend($('<li>').html(msg));
        });

        socket.on('topic update', function (topic) {
          console.log('topic update event!' + topic);
          $('#topic').val(topic);
          voteReset();
        });

        socket.on('vote update', function (votes) {
          console.log('topic update event!');

          data.votes = {};

          $('#votes').html('');
          votes.forEach(function(element) {
            data.votes[element.vote] = typeof(data.votes[element.vote]) !== 'undefined' ? data.votes[element.vote] + 1 : 1;
            $('#votes').prepend($('<li>').html('<span class="name">'  + element.nickname + '</span>' + '<span class="vote">'  + element.vote + '</span>' ));
          });

          if (votes.length == 0) {
            voteReset();
          }

          cardsUpdateView();
          votesUpdateView();
        });

        // UI:
        var typingTimer;
        $('#topic').on("input", function() {
          clearTimeout(typingTimer);
          var topic = $(this).val();
          // Update topic with a delay:
          typingTimer = setTimeout(function() {
            socket.emit('topic update', topic);
          }, 1000);
        });

        $('input[name=points]').change(function () {
          socket.emit('vote update', $(this).val());
        });

        $('#reset').click(function () {
          socket.emit('vote reset', $(this).val());
        });

        /**
         * Cards view.
         * Only show votes after making own.
         */
        function cardsUpdateView() {
          $('.card').each(function (index) {
            var $this = $(this);
            var val = $this.find('input[name=points]').val();
            var total = typeof (data.votes[val]) !== 'undefined' ? data.votes[val] : 0;
            var $votes = $this.find('.votes');
            $votes.text(total).show();
            if (total == 0 || !haveIVoted()) {
              $votes.hide();
            }
          });
        }

        function votesUpdateView() {
          haveIVoted() ? $('#votes').css("visibility", "visible") : $('#votes').css("visibility", "hidden");
        }

        function haveIVoted() {
          return $('input[name=points]:checked').val();
        }

        cardsUpdateView();

        function voteReset() {
          $('input[name=points]:checked').removeAttr("checked");
        }


      });
    </script>
  </body>
</html>
